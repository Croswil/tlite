#!/usr/bin/env node
import e from"fs";import t from"path";import{init as i,B as r}from"liburno_lib";import n from"yaml";import o from"minimist";const{Reset:a,Bold:l,Reverse:s,Red:c,Green:p,Yellow:d,Blue:f,Magenta:v,Cyan:m,White:u}=i(),g=`-------------------------------------------------------------\n${m}${l}tlite-env${a}: utility multiscopo database ${u}(c) Croswil  v. ${d}${l}1.2.24${a}\n-------------------------------------------------------------${a}\n${l}Uso: ${p}tlite-env <flags> ${a}  \n\n${l}flags:${a}\n   ${p}-h, --help${a}              mostra l'help\n   ${p}-m, --mode${a} <modo>       modo sul file .env [public,test,altro]   \n   ${p}-d, --dbapp${a}             Crea il file dbapp   \n   ${p}-r, --route${a}             Crea routing\n   ${p}-a, --abilita${a}           Crea md/abilitazioni.json   \n`;var $=o(process.argv);function S(e,t,i,r){var n=0;for(var o of e)t&&t(o,i,n),n++,o.data&&S(o.data,t,o)}(0==$._.length||$.h||$.help)&&(console.log(g),process.exit(0)),i();var y=0;const h=["public","test","altro"];var b=$.m||$.mode;if(b&&h.includes(b))if(e.existsSync(".env")){var j=e.readFileSync(".env").toString().split("\n"),x=h.filter((e=>e!=b)).join("|"),w=new RegExp(`^##\\s*(${x})\\s*$`,"im"),F=[];for(var A of j)/^##\s*/.test(A)&&(y=0),w.test(A)?y=1:A&&A.indexOf("=")>0&&(A=A.replace(/^\s*x_/,""),y&&(A="x_"+A.trim())),F.push(A);e.writeFileSync(".env",F.join("\n")),console.log("ATTIVATO: ",b)}else console.log("file .env not found");if($.d||$.dbapp){function me(t){var i=e.readdirSync(t);i=i.filter((e=>".yaml"==e.slice(-5)));var r=[];for(var o of i){var a=e.readFileSync(`${t}/${o}`).toString();a.startsWith("#!db")&&r.push(a)}r=r.join("\n\n");var l=n.parse(r);for(var o in l){var s=l[o],c=[],p=!1;for(var d in s)if(d&&!d.startsWith("__"))if("rowid"==d||"id"==d)delete s[d];else if(s[d]){var f=s[d].split(","),v=(f[0]||"").toLowerCase().trim();if(f.length>0&&(f[1]||f[2]||f[3])){f[1]||(f[1]=d);var m={cod:"?"==d[0]?d.slice(1):d,des:f[1]};f[2]&&(m.type=f[2]||""),parseInt(f[3])&&(m.visible=!0),1==parseInt(f[3])&&"?"!=d[0]&&(m.sort=!0),p=!0,c.push(m)}"?"!=d[0]?s[d]=v:delete s[d]}p&&(O[o]=c)}return l}const ue="dbdef";e.existsSync(ue)||(console.log("folder dbdef not found"),process.exit(1));var C={},O={};j=e.readdirSync(ue);for(var A of j){var k=`${ue}/${A}`;e.statSync(k).isDirectory()&&(console.log(A),C[A]=me(k))}console.log("tables"),C.tables=me(ue),console.log("filtri"),C.filtri=O,e.writeFileSync("dbapp.json",JSON.stringify(C,null,2)),console.log("creato: dbapp.json")}if($.a||$.abilita){var _=e.readFileSync("dbdef/abilitazioni.txt").toString().lines().sort(),z=[],I={},J=0;for(var N of _){var L=(A=N.split("//")[0].split(","))[0].trim(),R=(A[1]||"").trim();if(L){A=L.split(".");for(var T=[],W=0;W<A.length;W++){var B=T.join(".");T.push(A[W]);var D=T.join(".");I[D]||(J++,I[D]=J,z.push({id:J,level:W,padre:B&&I[B]?I[B]:0,cod:D,des:R}))}}}e.writeFileSync("md/abilitazioni.json",JSON.stringify(z,null,2)),console.log("created abilitazioni.json")}if($.r||$.route){var E=new Set;const ge="dbdef";var G=`${ge}/mappa.tpl`;e.existsSync(G)||(console.log(`file ${G} not found`),process.exit(1));var U=e.existsSync("md")&&e.existsSync("md/menu.json"),M=[],V={};U&&(M=JSON.parse(e.readFileSync("md/menu.json")));var Y={_root:[""]},q=".";if(e.existsSync(G)){j=e.readFileSync(G).toString().replaceAll("\r","\n").split("\n");for(var H of j){if((A=H.split("//")[0].trim()).length>0)(w=/^\s*\[(\w+)\]\s*$/gim.exec(A))?q=w[1]:(Y[q]||(Y[q]=[]),Y[q].push(A))}}var K=e.readFileSync(`${ge}/+page.svelte.tpl`).toString(),P=e.readFileSync(`${ge}/+page.js.tpl`).toString();const $e="src/routes";var Q=[],X=[],Z={};for(var H of(r.creaCartella($e),Y._root)){var ee=((de=H.split("="))[1]||"").split([","]),te=(A=de[0].trim(),(I=(ee[2]||"").trim().toLowerCase()).split(";"));for(var ie of te)ie&&!Z[ie]&&(Z[ie]=1);var re=(ee[1]||"").trim().toLowerCase();A&&Q.push(`   "${A}" : { level: ${parseInt(ee[0])||0}, auth: "${re}" ${I?', doc: "'+I+'"':""} }`);re=ee[1];if(U){function ye(e,t,i){var{match:r,auth:i}=ve(t,e.link,i);r&&(e.auth=(i||"").trim(),e.op=1)}S(M,(e=>ye(e,A,re)))}var ne=A.split("/").pop()+"/",oe=t.join($e,A);r.creaCartella(oe);var ae=t.join(oe,"+page.svelte"),le=t.join(oe,"+page.js"),se=/\[(\w+)\]/gim.test(A),ce=K,pe=P;e.existsSync(ae)||(console.log(ae),ce=(ce=ce.replaceAll("##pat0##",ne)).replaceAll("##pat##",A),ce=se?(ce=ce.replaceAll("##data##","export let data")).replaceAll("##jdata##",'\n                <div class="text-sm mt-5">\n                    <Json value={data} open />\n                </div>'):(ce=ce.replaceAll("##data##","")).replaceAll("##jdata##",""),e.writeFileSync(ae,ce)),se&&(e.existsSync(le)||e.writeFileSync(le,`${pe}`))}for(var H of Y._spec){var de;ee=((de=H.split("="))[1]||"").trim();(A=de[0].trim())&&ee&&X.push(`{ k: "${A}",doc: "${ee}" } `)}function Se(i){var r,n=e.readdirSync(i);for(var o of n){var a=t.join(i,o);if(a.endsWith(".svelte"))for(var l=e.readFileSync(t.join(i,o)).toString().replaceAll("\n"," ").toString();;){var s=/<(Bicon|BtnIcon|Icon)\s.*?img="(\w+)"/gim.exec(l);if(!s)break;(r=((r=s[2])||"").trim())&&!E.has(r)&&E.add(r),l=l.substr(s.index+s[0].length)}else{e.statSync(a).isDirectory()&&Se(a)}}}Se("src");var fe=[...E];if(fe.sort(),console.log("menu",U),U){V={};function he(e){if(e.auth){var t=e.auth,i=t.indexOf(";");i>=0&&(t=t.slice(i+1).trim()),V[t]||(V[t]=e.name||e.des||e.link)}e.op?delete e.op:e.link&&(e.auth="")}S(M,(e=>he(e))),e.writeFileSync("md/menu.json",JSON.stringify(M,null,2)),e.writeFileSync("md/linkmain.json",JSON.stringify(V,null,2))}r.creaCartella("src/lib"),e.writeFileSync("src/lib/abauto.js",`// **** AUTOGENERATO DA parseenv -r : variabili e autorizzazioni per il routing ****\n\nexport const abauto={\n   ${Q.join(",\n   ")}\n};\n\nexport const abextra=[\n   ${X.join(",\n   ")}\n]\n    \nexport const dockeys=[\n   "${Object.keys(Z).sort().join('",\n   "')}"\n]\n    \nexport const sicons=[\n   "${fe.join('",\n   "')}"\n]`)}function ve(e,t,i){i=i||"";var r=!1;if(e&&t){var n=e.trim().toLowerCase().split("/"),o=t.trim().toLowerCase().split("/");if(n.length==o.length){r=!0;for(var a=1;a<n.length;a++){if(!n[a].startsWith("[")&&n[a]!=o[a]){r=!1;break}i=i.replace("$"+(a-1),o[a])}}}return{match:r,auth:i}}
