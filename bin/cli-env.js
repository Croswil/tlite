#!/usr/bin/env node
import e from"fs";import t from"path";import{init as i,B as r}from"liburno_lib";import n from"yaml";import o from"minimist";const{Reset:a,Bold:l,Reverse:s,Red:c,Green:p,Yellow:d,Blue:f,Magenta:m,Cyan:v,White:u}=i(),g=`-------------------------------------------------------------\n${v}${l}tlite-env${a}: utility multiscopo database ${u}(c) Croswil  v. ${d}${l}1.2.30${a}\n-------------------------------------------------------------${a}\n${l}Uso: ${p}tlite-env <flags> ${a}  \n\n${l}flags:${a}\n   ${p}-h, --help${a}              mostra l'help\n   ${p}-m, --mode${a} <modo>       modo sul file .env [public,test,altro]   \n   ${p}-d, --dbapp${a}             Crea il file dbapp   \n   ${p}-r, --route${a}             Crea routing\n   ${p}-a, --abilita${a}           Crea md/abilitazioni.json   \n`;var $=o(process.argv);function S(e,t,i,r){var n=0;for(var o of e)t&&t(o,i,n),n++,o.data&&S(o.data,t,o)}(0==$._.length||$.h||$.help)&&(console.log(g),process.exit(0)),i();var y=0;const h=["public","test","altro"];var b=$.m||$.mode;if(b&&h.includes(b))if(e.existsSync(".env")){var j=e.readFileSync(".env").toString().split("\n"),x=h.filter((e=>e!=b)).join("|"),w=new RegExp(`^##\\s*(${x})\\s*$`,"im"),F=[];for(var C of j)/^##\s*/.test(C)&&(y=0),w.test(C)?y=1:C&&C.indexOf("=")>0&&(C=C.replace(/^\s*x_/,""),y&&(C="x_"+C.trim())),F.push(C);e.writeFileSync(".env",F.join("\n")),console.log("ATTIVATO: ",b)}else console.log("file .env not found");if($.d||$.dbapp){function ve(t){var i=e.readdirSync(t);i=i.filter((e=>".yaml"==e.slice(-5)));var r=[];for(var o of i){var a=e.readFileSync(`${t}/${o}`).toString();a.startsWith("#!db")&&r.push(a)}r=r.join("\n\n");var l=n.parse(r);for(var o in l){var s=l[o],c=[],p=!1;for(var d in s)if(d&&!d.startsWith("__"))if("rowid"==d||"id"==d)delete s[d];else if(s[d]){var f=s[d].split(","),m=(f[0]||"").toLowerCase().trim();if(f.length>0&&(f[1]||f[2]||f[3])){f[1]||(f[1]=d);var v={cod:"?"==d[0]?d.slice(1):d,des:f[1]};f[2]&&(v.type=f[2]||""),parseInt(f[3])&&(v.visible=!0),1==parseInt(f[3])&&"?"!=d[0]&&(v.sort=!0),p=!0,c.push(v)}"?"!=d[0]?s[d]=m:delete s[d]}p&&(k[o]=c)}return l}const ue="dbdef";e.existsSync(ue)||(console.log("folder dbdef not found"),process.exit(1));var A={},k={};j=e.readdirSync(ue);for(var C of j){var O=`${ue}/${C}`;e.statSync(O).isDirectory()&&(console.log(C),A[C]=ve(O))}console.log("tables"),A.tables=ve(ue),console.log("filtri"),A.filtri=k,e.writeFileSync("dbapp.json",JSON.stringify(A,null,2)),console.log("creato: dbapp.json")}if($.a||$.abilita){var L=e.readFileSync("dbdef/abilitazioni.txt").toString().lines().sort(),_=[],z={},I=0;for(var J of L){var N=(C=J.split("//")[0].split(","))[0].trim(),R=(C[1]||"").trim();if(N){C=N.split(".");for(var T=[],W=0;W<C.length;W++){var B=T.join(".");T.push(C[W]);var D=T.join(".");z[D]||(I++,z[D]=I,_.push({id:I,level:W,padre:B&&z[B]?z[B]:0,cod:D,des:R}))}}}e.writeFileSync("md/abilitazioni.json",JSON.stringify(_,null,2)),console.log("created abilitazioni.json")}if($.r||$.route){var E=new Set;const ge="dbdef";var G=`${ge}/mappa.tpl`;e.existsSync(G)||(console.log(`file ${G} not found`),process.exit(1));var U=e.existsSync("md")&&e.existsSync("md/menu.json"),M=[],V={};U&&(M=e.existsSync("dbdef/menu.md")?function(){var t=e.readFileSync("dbdef/menu.md").toString().lines(),i=[],r=void 0;for(var n of(console.log("parsing menu.md"),t))if(n=n.split("// ")[0].trim()){var o=n.split(","),a=o[0].trim().toLowerCase(),l=(o[1]||"").trim().toLowerCase(),s=(o[2]||"").trim().toLowerCase(),c=(o[3]||"").trim().toLowerCase(),p=(o[4]||"").trim().toLowerCase();"#"==a?(r={link:"",name:l,auth:s,icon:c,info:p,data:[]},i.push(r)):r?r.data.push({link:a,name:l,auth:s,icon:c,info:p}):console.log(`menu.md miss: ${a}=>${l}`)}return i}():JSON.parse(e.readFileSync("md/menu.json")));var Y={_root:[""]},q=".";if(e.existsSync(G)){j=e.readFileSync(G).toString().replaceAll("\r","\n").split("\n");for(var H of j){if((C=H.split("//")[0].trim()).length>0)(w=/^\s*\[(\w+)\]\s*$/gim.exec(C))?q=w[1]:(Y[q]||(Y[q]=[]),Y[q].push(C))}}var K=e.readFileSync(`${ge}/+page.svelte.tpl`).toString(),P=e.readFileSync(`${ge}/+page.js.tpl`).toString();const $e="src/routes";var Q=[],X=[],Z={};for(var H of(r.creaCartella($e),Y._root)){var ee=((de=H.split("="))[1]||"").split([","]),te=(C=de[0].trim(),(z=(ee[2]||"").trim().toLowerCase()).split(";"));for(var ie of te)ie&&!Z[ie]&&(Z[ie]=1);var re=(ee[1]||"").trim().toLowerCase();C&&Q.push(`   "${C}" : { level: ${parseInt(ee[0])||0}, auth: "${re}" ${z?', doc: "'+z+'"':""} }`);re=ee[1];if(U){function ye(e,t,i){var{match:r,auth:i}=me(t,e.link,i);r&&(e.auth=(i||"").trim(),e.op=1)}S(M,(e=>ye(e,C,re)))}var ne=C.split("/").pop()+"/",oe=t.join($e,C);r.creaCartella(oe);var ae=t.join(oe,"+page.svelte"),le=t.join(oe,"+page.js"),se=/\[(\w+)\]/gim.test(C),ce=K,pe=P;e.existsSync(ae)||(console.log(ae),ce=(ce=ce.replaceAll("##pat0##",ne)).replaceAll("##pat##",C),ce=se?(ce=ce.replaceAll("##data##","export let data")).replaceAll("##jdata##",'\n                <div class="text-sm mt-5">\n                    <Json value={data} open />\n                </div>'):(ce=ce.replaceAll("##data##","")).replaceAll("##jdata##",""),e.writeFileSync(ae,ce)),se&&(e.existsSync(le)||e.writeFileSync(le,`${pe}`))}for(var H of Y._spec){var de;ee=((de=H.split("="))[1]||"").trim();(C=de[0].trim())&&ee&&X.push(`{ k: "${C}",doc: "${ee}" } `)}function Se(i){var r,n=e.readdirSync(i);for(var o of n){var a=t.join(i,o);if(a.endsWith(".svelte"))for(var l=e.readFileSync(t.join(i,o)).toString().replaceAll("\n"," ").toString();;){var s=/<(Bicon|BtnIcon|Icon)\s.*?img="([\w\u0400-\uFFFF\u{1F600}-\u{1FAFF}]+)"/imu.exec(l);if(!s)break;(r=((r=s[2])||"").trim())&&!E.has(r)&&E.add(r),l=l.substr(s.index+s[0].length)}else{e.statSync(a).isDirectory()&&Se(a)}}}Se("src");var fe=[...E];if(fe.sort(),console.log("menu",U),U){V={};function he(e){if(e.auth){var t=e.auth,i=t.indexOf(";");i>=0&&(t=t.slice(i+1).trim()),V[t]||(V[t]=e.name||e.des||e.link)}e.op?delete e.op:e.link&&(e.auth="")}S(M,(e=>he(e))),e.writeFileSync("md/menu.json",JSON.stringify(M,null,2)),e.writeFileSync("md/linkmain.json",JSON.stringify(V,null,2))}r.creaCartella("src/lib"),e.writeFileSync("src/lib/abauto.js",`// **** AUTOGENERATO DA parseenv -r : variabili e autorizzazioni per il routing ****\n\nexport const abauto={\n   ${Q.join(",\n   ")}\n};\n\nexport const abextra=[\n   ${X.join(",\n   ")}\n]\n    \nexport const dockeys=[\n   "${Object.keys(Z).sort().join('",\n   "')}"\n]\n    \nexport const sicons=[\n   "${fe.join('",\n   "')}"\n]`)}function me(e,t,i){i=i||"";var r=!1;if(e&&t){var n=e.trim().toLowerCase().split("/"),o=t.trim().toLowerCase().split("/");if(n.length==o.length){r=!0;for(var a=1;a<n.length;a++){if(!n[a].startsWith("[")&&n[a]!=o[a]){r=!1;break}i=i.replace("$"+(a-1),o[a])}}}return{match:r,auth:i}}
