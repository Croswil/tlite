#! /usr/local/bin/node
import e from"fs";import r from"path";import{init as n,B as t}from"liburno_lib";import i from"yaml";import o from"minimist";const{Reset:a,Bold:l,Reverse:s,Red:c,Green:p,Yellow:f,Blue:d,Magenta:m,Cyan:v,White:u}=n(),g=`${l}parseenv${a} :             Utility multiscopo per siti ERP Croswil 2023 v1.1\n${l}Uso: ${p}parseenv <flags> ${a} Modifica il file di configurazione per gestione locale e remota  \n\n${l}flags:${a}\n   ${p}-h, --help${a}              mostra l'help\n   ${p}-m, --mode${a} <modo>       modo sul file .env [public,test,altro]   \n   ${p}-d, --dbapp${a}             Crea il file dbapp   \n   ${p}-r, --route${a}             Crea routing   \n`;var S=o(process.argv);function y(e,r,n,t){var i=0;for(var o of e)r&&r(o,n,i),i++,o.data&&y(o.data,r,o)}(0==S._.length||S.h||S.help)&&(console.log(g),process.exit(0)),n();var $=0;const h=["public","test","altro"];var j=S.m||S.mode;if(j&&h.includes(j))if(e.existsSync(".env")){var x=e.readFileSync(".env").toString().split("\n"),b=h.filter((e=>e!=j)).join("|"),w=new RegExp(`^##\\s*(${b})\\s*$`,"im"),F=[];for(var A of x)/^##\s*/.test(A)&&($=0),w.test(A)?$=1:A&&A.indexOf("=")>0&&(A=A.replace(/^\s*x_/,""),$&&(A="x_"+A.trim())),F.push(A);e.writeFileSync(".env",F.join("\n")),console.log("ATTIVATO: ",j)}else console.log("file .env not found");else if(S.d||S.dbapp){function oe(r){var n=e.readdirSync(r);n=n.filter((e=>".yaml"==e.slice(-5)));var t=[];for(var o of n){var a=e.readFileSync(`${r}/${o}`).toString();a.startsWith("#!db")&&t.push(a)}t=t.join("\n\n");var l=i.parse(t);for(var o in l){var s=l[o],c=[],p=!1;for(var f in s)if(f&&!f.startsWith("__"))if("rowid"==f||"id"==f)delete s[f];else if(s[f]){var d=s[f].split(","),m=(d[0]||"").toLowerCase().trim();if(d.length>0&&(d[1]||d[2]||d[3])){d[1]||(d[1]=f);var v={cod:"?"==f[0]?f.slice(1):f,des:d[1]};d[2]&&(v.type=d[2]||""),parseInt(d[3])&&(v.visible=!0),1==parseInt(d[3])&&"?"!=f[0]&&(v.sort=!0),p=!0,c.push(v)}"?"!=f[0]?s[f]=m:delete s[f]}p&&(O[o]=c)}return l}const ae="dbdef";e.existsSync(ae)||(console.log("folder dbdef not found"),process.exit(1));var C={},O={};x=e.readdirSync(ae);for(var A of x){var k=`${ae}/${A}`;e.statSync(k).isDirectory()&&(console.log(A),C[A]=oe(k))}console.log("tables"),C.tables=oe(ae),console.log("filtri"),C.filtri=O,e.writeFileSync("dbapp.json",JSON.stringify(C,null,2)),console.log("creato: dbapp.json")}else if(S.r||S.route){var _=new Set;const le="dbdef";var J=`${le}/mappa.tpl`;e.existsSync(J)||(console.log(`file ${J} not found`),process.exit(1));var N=e.existsSync("md")&&e.existsSync("md/menu.json")&&e.existsSync("md/menumain.json"),I=[],R=[],L={};N&&(I=JSON.parse(e.readFileSync("md/menu.json")),R=JSON.parse(e.readFileSync("md/menumain.json")));var T={_root:[""]},W=".";if(e.existsSync(J)){x=e.readFileSync(J).toString().replaceAll("\r","\n").split("\n");for(var z of x){if((A=z.split("//")[0].trim()).length>0)(w=/^\s*\[(\w+)\]\s*$/gim.exec(A))?W=w[1]:(T[W]||(T[W]=[]),T[W].push(A))}}var B=e.readFileSync(`${le}/+page.svelte.tpl`).toString(),E=e.readFileSync(`${le}/+page.js.tpl`).toString();const se="src/routes";var D=[],U=[],G={};for(var z of(t.creaCartella(se),T._root)){var M=((ne=z.split("="))[1]||"").split([","]),P=(A=ne[0].trim(),(M[2]||"").trim().toLowerCase()),V=P.split(";");for(var Y of V)Y&&!G[Y]&&(G[Y]=1);var q=(M[1]||"").trim().toLowerCase();A&&D.push(`   "${A}" : { level: ${parseInt(M[0])||0}, auth: "${q}" ${P?', doc: "'+P+'"':""} }`);q=M[1];if(N){function pe(e,r,n){var{match:t,auth:n}=ie(r,e.link,n);t&&(e.auth=(n||"").trim(),e.op=1)}y(I,(e=>pe(e,A,q))),y(R,(e=>pe(e,A,q)))}var H=A.split("/").pop()+"/",K=r.join(se,A);t.creaCartella(K);var Q=r.join(K,"+page.svelte"),X=r.join(K,"+page.js"),Z=/\[(\w+)\]/gim.test(A),ee=B,re=E;e.existsSync(Q)||(console.log(Q),ee=(ee=ee.replaceAll("##pat0##",H)).replaceAll("##pat##",A),ee=Z?(ee=ee.replaceAll("##data##","export let data")).replaceAll("##jdata##",'\n                <div class="text-sm mt-5">\n                    <Json value={data} open />\n                </div>'):(ee=ee.replaceAll("##data##","")).replaceAll("##jdata##",""),e.writeFileSync(Q,ee)),Z&&(e.existsSync(X)||e.writeFileSync(X,`${re}`))}for(var z of T._spec){var ne;M=((ne=z.split("="))[1]||"").trim();(A=ne[0].trim())&&M&&U.push(`{ k: "${A}",doc: "${M}" } `)}function ce(n){var t,i=e.readdirSync(n);for(var o of i){var a=r.join(n,o);if(a.endsWith(".svelte"))for(var l=e.readFileSync(r.join(n,o)).toString().replaceAll("\n"," ").toString();;){var s=/<(Bicon|BtnIcon|Icon)\s.*?img="(\w+)"/gim.exec(l);if(!s)break;(t=((t=s[2])||"").trim())&&!_.has(t)&&_.add(t),l=l.substr(s.index+s[0].length)}else{e.statSync(a).isDirectory()&&ce(a)}}}ce("src");var te=[..._];if(te.sort(),console.log("menu",N),N){L={};function fe(e){if(e.auth){var r=e.auth,n=r.indexOf(";");n>=0&&(r=r.slice(n+1).trim()),L[r]||(L[r]=e.name||e.des||e.link)}e.op?delete e.op:e.link&&(e.auth="")}y(I,(e=>fe(e))),y(R,(e=>fe(e))),e.writeFileSync("md/menu.json",JSON.stringify(I,null,2)),e.writeFileSync("md/menumain.json",JSON.stringify(R,null,2)),e.writeFileSync("md/linkmain.json",JSON.stringify(L,null,2))}t.creaCartella("src/lib"),e.writeFileSync("src/lib/abauto.js",`// **** AUTOGENERATO DA parseenv -r : variabili e autorizzazioni per il routing ****\n\nexport const abauto={\n   ${D.join(",\n   ")}\n};\n\nexport const abextra=[\n   ${U.join(",\n   ")}\n]\n    \nexport const dockeys=[\n   "${Object.keys(G).sort().join('",\n   "')}"\n]\n    \nexport const sicons=[\n   "${te.join('",\n   "')}"\n]`)}else console.log(g),console.log("wrong options");function ie(e,r,n){n=n||"";var t=!1;if(e&&r){var i=e.trim().toLowerCase().split("/"),o=r.trim().toLowerCase().split("/");if(i.length==o.length){t=!0;for(var a=1;a<i.length;a++){if(!i[a].startsWith("[")&&i[a]!=o[a]){t=!1;break}n=n.replace("$"+(a-1),o[a])}}}return{match:t,auth:n}}
